<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.9.1"/>
<title>AcUtils: LatestOverlaps.cs</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="Doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="Verizon.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">AcUtils
   </div>
   <div id="projectbrief">A high performance abstraction layer for AccuRev</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.9.1 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="usergroup0.html"><span>Docs</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="group__acenum.html"><span>Enums</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">LatestOverlaps.cs</div>  </div>
</div><!--header-->
<div class="contents">
<p>Creates an HTML file with promotions to streams in select depots within the past specified number of hours that have one or more versions with overlap status. Only promotions that occurred <em>FromHoursAgo</em> listed in <code>LatestOverlaps.exe.config</code> are shown.</p>
<dl class="section user"><dt>LatestOverlaps.exe.config</dt><dd></dd></dl>
<div class="fragment"><div class="line">&lt;?xml version=<span class="stringliteral">&quot;1.0&quot;</span> encoding=<span class="stringliteral">&quot;utf-8&quot;</span>?&gt;</div>
<div class="line">&lt;configuration&gt;</div>
<div class="line">  &lt;configSections&gt;</div>
<div class="line">    &lt;section name=<span class="stringliteral">&quot;activeDir&quot;</span> type=<span class="stringliteral">&quot;AcUtils.ADSection, AcUtils, Version=1.6.4.0, Culture=neutral, PublicKeyToken=26470c2daf5c2e2f, processorArchitecture=MSIL&quot;</span>/&gt;</div>
<div class="line">    &lt;section name=<span class="stringliteral">&quot;Depots&quot;</span> type=<span class="stringliteral">&quot;AcUtils.DepotsSection, AcUtils, Version=1.6.4.0, Culture=neutral, PublicKeyToken=26470c2daf5c2e2f, processorArchitecture=MSIL&quot;</span>/&gt;</div>
<div class="line">  &lt;/configSections&gt;</div>
<div class="line">  &lt;activeDir&gt;</div>
<div class="line">    &lt;domains&gt;</div>
<div class="line">      &lt;!-- contact your company LDAP administrator <span class="keywordflow">for</span> these values --&gt;</div>
<div class="line">      &lt;add host=<span class="stringliteral">&quot;xyzdc.yourcorp.com&quot;</span> path=<span class="stringliteral">&quot;DC=OMIT1,DC=ad,DC=yourcorp,DC=com&quot;</span>/&gt;</div>
<div class="line">      &lt;add host=<span class="stringliteral">&quot;abcdc.yourcorp.com&quot;</span> path=<span class="stringliteral">&quot;DC=OMIT2,DC=yourcorp,DC=com&quot;</span>/&gt;</div>
<div class="line">    &lt;/domains&gt;</div>
<div class="line">    &lt;properties&gt;</div>
<div class="line">      &lt;add field=<span class="stringliteral">&quot;mobile&quot;</span> title=<span class="stringliteral">&quot;Mobile&quot;</span>/&gt;</div>
<div class="line">    &lt;/properties&gt;</div>
<div class="line">  &lt;/activeDir&gt;</div>
<div class="line">  &lt;Depots&gt;</div>
<div class="line">    &lt;depots&gt;</div>
<div class="line">      &lt;!-- depots <a name="a0"></a><a class="code" href="group__acenum.html#gga2149004df4de6f7f8763b1c46d4ade17a01b6e20344b68835c5ed1ddedf20d531">to</a> scan <span class="keywordflow">for</span> versions with overlap status --&gt;</div>
<div class="line">      &lt;add <a class="code" href="namespace_ac_utils.html#ga40cba942bbed1ac998223575478e4d6fa6f13b876f224fb5d11c729c36a871540">depot</a>=<span class="stringliteral">&quot;MARS&quot;</span>/&gt;</div>
<div class="line">      &lt;add <a class="code" href="namespace_ac_utils.html#ga40cba942bbed1ac998223575478e4d6fa6f13b876f224fb5d11c729c36a871540">depot</a>=<span class="stringliteral">&quot;JUPITER&quot;</span>/&gt;</div>
<div class="line">      &lt;add <a class="code" href="namespace_ac_utils.html#ga40cba942bbed1ac998223575478e4d6fa6f13b876f224fb5d11c729c36a871540">depot</a>=<span class="stringliteral">&quot;NEPTUNE&quot;</span>/&gt;</div>
<div class="line">    &lt;/depots&gt;</div>
<div class="line">  &lt;/Depots&gt;</div>
<div class="line">  &lt;appSettings&gt;</div>
<div class="line">    &lt;add key=<span class="stringliteral">&quot;FromHoursAgo&quot;</span> value=<span class="stringliteral">&quot;24&quot;</span>/&gt;</div>
<div class="line">    &lt;add key=<span class="stringliteral">&quot;OutputFile&quot;</span> value=<span class="stringliteral">&quot;C:\Temp\LatestOverlaps.html&quot;</span>/&gt;</div>
<div class="line">  &lt;/appSettings&gt;</div>
<div class="line">  &lt;system.diagnostics&gt;</div>
<div class="line">    &lt;assert assertuienabled=<span class="stringliteral">&quot;false&quot;</span>/&gt;</div>
<div class="line">    &lt;sources&gt;</div>
<div class="line">      &lt;source name=<span class="stringliteral">&quot;LatestOverlaps&quot;</span>&gt;</div>
<div class="line">        &lt;listeners&gt;</div>
<div class="line">          &lt;<span class="keyword">remove</span> name=<span class="stringliteral">&quot;Default&quot;</span>/&gt;</div>
<div class="line">          &lt;add name=<span class="stringliteral">&quot;AcLog&quot;</span> type=<span class="stringliteral">&quot;Microsoft.VisualBasic.Logging.FileLogTraceListener, Microsoft.VisualBasic, Version=10.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a, processorArchitecture=MSIL&quot;</span>/&gt;</div>
<div class="line">        &lt;/listeners&gt;</div>
<div class="line">      &lt;/source&gt;</div>
<div class="line">    &lt;/sources&gt;</div>
<div class="line">  &lt;/system.diagnostics&gt;</div>
<div class="line">  &lt;startup&gt;</div>
<div class="line">    &lt;supportedRuntime version=<span class="stringliteral">&quot;v4.0&quot;</span> sku=<span class="stringliteral">&quot;.NETFramework,Version=v4.6.1&quot;</span>/&gt;</div>
<div class="line">  &lt;/startup&gt;</div>
<div class="line">&lt;/configuration&gt;</div>
</div><!-- fragment --><dl class="section see"><dt>See also</dt><dd><a class="el" href="class_ac_utils_1_1_ac_users.html#ab9d6d159b5de4c3ef7ec201c6fde60bf">AcUsers constructor</a>, <a class="el" href="class_ac_utils_1_1_stat.html#a36055e2997ebee4102e469dde6d59954">Stat.getElement</a>, <a href="_latest_promotions_8cs-example.html">LatestPromotions.cs</a></dd></dl>
<div class="fragment"><div class="line"><span class="comment">/* Copyright (C) 2018 Verizon. All Rights Reserved.</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span></div>
<div class="line"><span class="comment">you may not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment">You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment">    http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment"></span></div>
<div class="line"><span class="comment">Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment">distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span></div>
<div class="line"><span class="comment">WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment">See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment">limitations under the License. */</span></div>
<div class="line"></div>
<div class="line"><span class="comment">// Required references: AcUtils.dll, System, System.configuration, System.Xml, System.Xml.Linq</span></div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Collections.Generic;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Configuration;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Diagnostics;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.IO;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Linq;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Text;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.<a class="code" href="namespace_system_1_1_threading.html">Threading</a>.<a class="code" href="namespace_system_1_1_threading_1_1_tasks.html">Tasks</a>;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Xml;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_system.html">System</a>.Xml.Linq;</div>
<div class="line"><span class="keyword">using</span> <a class="code" href="namespace_ac_utils.html">AcUtils</a>;</div>
<div class="line"></div>
<div class="line"><span class="keyword">namespace </span>LatestOverlaps</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">class </span>Program</div>
<div class="line">    {</div>
<div class="line"><span class="preprocessor">        #region class variables</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> DomainCollection _domains;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> PropCollection _properties;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> DepotsCollection _selDepots;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">int</span> _fromHoursAgo;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">string</span> _outputFile;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> AcUsers _users;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> AcDepots _depots;</div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> List&lt;XElement&gt; _hist;</div>
<div class="line"><span class="preprocessor">        #endregion</span></div>
<div class="line"></div>
<div class="line">        <span class="keyword">static</span> <span class="keywordtype">int</span> Main(<span class="keywordtype">string</span>[] args)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// general program startup initialization</span></div>
<div class="line">            <span class="keywordflow">if</span> (!init()) <span class="keywordflow">return</span> 1; <span class="comment">// initialization failure, check log file</span></div>
<div class="line">            <span class="keywordflow">return</span> (reportAsync().Result) ? 0 : 1;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> async Task&lt;bool&gt; reportAsync()</div>
<div class="line">        {</div>
<div class="line">            DateTime past = DateTime.Now.AddHours(_fromHoursAgo * -1); <span class="comment">// go back this many hours</span></div>
<div class="line">            <span class="keywordflow">if</span> (!(await initHistAsync(past))) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            <span class="keywordflow">if</span> (_hist != null &amp;&amp; _hist.Count &gt; 0)</div>
<div class="line">            {</div>
<div class="line">                <span class="keywordflow">if</span> (!(await initStatAsync())) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                XmlWriter writer = null;</div>
<div class="line">                <span class="keywordflow">try</span></div>
<div class="line">                {</div>
<div class="line">                    XmlWriterSettings settings = <span class="keyword">new</span> XmlWriterSettings {</div>
<div class="line">                        OmitXmlDeclaration = <span class="keyword">true</span>, Indent = <span class="keyword">true</span>, IndentChars = <span class="stringliteral">&quot;\t&quot;</span>,</div>
<div class="line">                        Encoding = <span class="keyword">new</span> UTF8Encoding(<span class="keyword">false</span>) <span class="comment">// false to exclude Unicode byte order mark (BOM)</span></div>
<div class="line">                    };</div>
<div class="line">                    <span class="keyword">using</span> (writer = XmlWriter.Create(_outputFile, settings))</div>
<div class="line">                    {</div>
<div class="line">                        XDocument report = buildReport(past);</div>
<div class="line">                        report.WriteTo(writer);</div>
<div class="line">                    }</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">catch</span> (Exception exc)</div>
<div class="line">                {</div>
<div class="line">                    AcDebug.Log($<span class="stringliteral">&quot;Exception caught and logged in Program.reportAsync{Environment.NewLine}&quot;</span> +</div>
<div class="line">                        $<span class="stringliteral">&quot;Failed writing to {_outputFile}{Environment.NewLine}{exc.Message}&quot;</span>);</div>
<div class="line">                    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordflow">finally</span> { <span class="keywordflow">if</span> (writer != null) writer.Close(); }</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Run the hist command for depots listed in LatestOverlaps.exe.config and add the results to </span></div>
<div class="line">        <span class="comment">// our history list class variable. Returns true if initialization succeeded, false otherwise. </span></div>
<div class="line">        <span class="comment">// AcUtilsException caught and logged in %LOCALAPPDATA%\AcTools\Logs\LatestOverlaps-YYYY-MM-DD.log </span></div>
<div class="line">        <span class="comment">// on hist command failure. Exception caught and logged in same for a range of exceptions.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> async Task&lt;bool&gt; initHistAsync(DateTime past)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">bool</span> ret = <span class="keyword">false</span>; <span class="comment">// assume failure</span></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                <span class="keywordtype">string</span> timeHrsAgo = AcDateTime.DateTime2AcDate(past); <span class="comment">// get date in string format suitable for AccuRev CLI</span></div>
<div class="line">                List&lt;Task&lt;AcResult&gt;&gt; tasks = <span class="keyword">new</span> List&lt;Task&lt;AcResult&gt;&gt;(_depots.Count);</div>
<div class="line">                <span class="keywordflow">foreach</span> (AcDepot <a class="code" href="namespace_ac_utils.html#ga40cba942bbed1ac998223575478e4d6fa6f13b876f224fb5d11c729c36a871540">depot</a> <span class="keywordflow">in</span> _depots)</div>
<div class="line">                    tasks.Add(AcCommand.runAsync($<span class="stringliteral">@&quot;hist -k promote -p &quot;&quot;{depot}&quot;&quot; -t now-&quot;&quot;{timeHrsAgo}&quot;&quot; -fex&quot;</span>));</div>
<div class="line"></div>
<div class="line">                _hist = <span class="keyword">new</span> List&lt;XElement&gt;(_depots.Count);</div>
<div class="line">                <span class="keywordflow">while</span> (tasks.Count &gt; 0)</div>
<div class="line">                {</div>
<div class="line">                    Task&lt;AcResult&gt; r = await Task.WhenAny(tasks);</div>
<div class="line">                    tasks.Remove(r);</div>
<div class="line">                    <span class="keywordflow">if</span> (r == null || r.Result.RetVal != 0) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">                    XElement xml = XElement.Parse(r.Result.CmdResult);</div>
<div class="line">                    _hist.Add(xml);</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                ret = <span class="keyword">true</span>; <span class="comment">// if we&#39;re here then all completed successfully</span></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">catch</span> (AcUtilsException exc)</div>
<div class="line">            {</div>
<div class="line">                AcDebug.Log($<span class="stringliteral">&quot;AcUtilsException caught and logged in Program.initHistAsync{Environment.NewLine}{exc.Message}&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">catch</span> (Exception ecx)</div>
<div class="line">            {</div>
<div class="line">                AcDebug.Log($<span class="stringliteral">&quot;Exception caught and logged in Program.initHistAsync{Environment.NewLine}{ecx.Message}&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Run the stat command for streams in depots listed in LatestOverlaps.exe.config and add the </span></div>
<div class="line">        <span class="comment">// results to the Stat.Elements list. Returns true if initialization succeeded, false otherwise. </span></div>
<div class="line">        <span class="comment">// AcUtilsException caught and logged in %LOCALAPPDATA%\AcTools\Logs\LatestOverlaps-YYYY-MM-DD.log </span></div>
<div class="line">        <span class="comment">// on stat command failure. Exception caught and logged in same for a range of exceptions.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> async Task&lt;bool&gt; initStatAsync()</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">bool</span> ret = <span class="keyword">false</span>; <span class="comment">// assume failure</span></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                IEnumerable&lt;XElement&gt; trans = <a name="a1"></a><a class="code" href="group__acenum.html#gga2149004df4de6f7f8763b1c46d4ade17ad98a07f84921b24ee30f86fd8cd85c3c">from</a> e in _hist.Elements(<span class="stringliteral">&quot;transaction&quot;</span>)</div>
<div class="line">                                              select e;</div>
<div class="line">                ILookup&lt;string, XElement&gt; map = trans.ToLookup(n =&gt; (<span class="keywordtype">string</span>)n.Attribute(<span class="stringliteral">&quot;streamName&quot;</span>), n =&gt; n);</div>
<div class="line"></div>
<div class="line">                List&lt;Task&lt;AcResult&gt;&gt; tasks = <span class="keyword">new</span> List&lt;Task&lt;AcResult&gt;&gt;();</div>
<div class="line">                <span class="keywordflow">foreach</span> (var ii <span class="keywordflow">in</span> map) <span class="comment">// for each stream</span></div>
<div class="line">                {</div>
<div class="line">                    AcStream <a name="a2"></a><a class="code" href="group__acenum.html#ggad7e684b07d7e19ab166efd38207cf884af7b44cfafd5c52223d5498196c8a2e7b">stream</a> = _depots.getStream(ii.Key);</div>
<div class="line">                    <span class="keywordflow">if</span> (!stream.HasDefaultGroup) <span class="keywordflow">continue</span>; <span class="comment">// run stat only if default group exists</span></div>
<div class="line">                    tasks.Add(AcCommand.runAsync($<span class="stringliteral">@&quot;stat -s &quot;&quot;{stream}&quot;&quot; -o -fx&quot;</span>));</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                <span class="keywordtype">bool</span> op = <span class="keyword">true</span>;</div>
<div class="line">                <span class="keywordflow">while</span> (tasks.Count &gt; 0 &amp;&amp; op)</div>
<div class="line">                {</div>
<div class="line">                    Task&lt;AcResult&gt; r = await Task.WhenAny(tasks);</div>
<div class="line">                    tasks.Remove(r);</div>
<div class="line">                    op = (r != null &amp;&amp; r.Result.RetVal == 0 &amp;&amp; Stat.init(r.Result.CmdResult));</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                ret = op; <span class="comment">// true if all completed successfully</span></div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">catch</span> (AcUtilsException exc)</div>
<div class="line">            {</div>
<div class="line">                AcDebug.Log($<span class="stringliteral">&quot;AcUtilsException caught and logged in Program.initStatAsync{Environment.NewLine}{exc.Message}&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">catch</span> (Exception ecx)</div>
<div class="line">            {</div>
<div class="line">                AcDebug.Log($<span class="stringliteral">&quot;Exception caught and logged in Program.initStatAsync{Environment.NewLine}{ecx.Message}&quot;</span>);</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Returns the content for our HTML file.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> XDocument buildReport(DateTime past)</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// transactions where one or more versions have overlap status</span></div>
<div class="line">            IEnumerable&lt;XElement&gt; trans = <a class="code" href="group__acenum.html#gga2149004df4de6f7f8763b1c46d4ade17ad98a07f84921b24ee30f86fd8cd85c3c">from</a> t in _hist.Elements(<span class="stringliteral">&quot;transaction&quot;</span>)</div>
<div class="line">                                          where Stat.getElement(t.Element(<span class="stringliteral">&quot;version&quot;</span>)) != null</div>
<div class="line">                                          select t;</div>
<div class="line">            ILookup&lt;string, XElement&gt; map = trans.ToLookup(n =&gt; (<span class="keywordtype">string</span>)n.Attribute(<span class="stringliteral">&quot;streamName&quot;</span>), n =&gt; n);</div>
<div class="line"></div>
<div class="line">            XDocument doc = <span class="keyword">new</span> XDocument(</div>
<div class="line">                <span class="keyword">new</span> XDocumentType(<span class="stringliteral">&quot;HTML&quot;</span>, null, null, null),</div>
<div class="line">                <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;html&quot;</span>, <span class="keyword">new</span> XAttribute(<span class="stringliteral">&quot;lang&quot;</span>, <span class="stringliteral">&quot;en&quot;</span>),</div>
<div class="line">                <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;head&quot;</span>,</div>
<div class="line">                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;meta&quot;</span>, <span class="keyword">new</span> XAttribute(<span class="stringliteral">&quot;charset&quot;</span>, <span class="stringliteral">&quot;utf-8&quot;</span>)), <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;meta&quot;</span>, <span class="keyword">new</span> XAttribute(<span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;description&quot;</span>),</div>
<div class="line">                        <span class="keyword">new</span> XAttribute(<span class="stringliteral">&quot;content&quot;</span>, <span class="stringliteral">&quot;Promotions to select depots within the past specified number of hours that have versions with overlap status.&quot;</span>)),</div>
<div class="line">                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;title&quot;</span>, <span class="stringliteral">&quot;Promotions with overlaps since &quot;</span> + past.ToString(<span class="stringliteral">&quot;f&quot;</span>)),</div>
<div class="line">                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;style&quot;</span>,</div>
<div class="line">                    $<span class="stringliteral">@&quot;body {{</span></div>
<div class="line"><span class="stringliteral">                      background-color: Gainsboro;</span></div>
<div class="line"><span class="stringliteral">                      color: #0000ff;</span></div>
<div class="line"><span class="stringliteral">                      font-family: Arial, sans-serif;</span></div>
<div class="line"><span class="stringliteral">                      font-size: 13px;</span></div>
<div class="line"><span class="stringliteral">                      margin: 10px; }}</span></div>
<div class="line"><span class="stringliteral">                    table {{</span></div>
<div class="line"><span class="stringliteral">                      background-color: #F1F1F1;</span></div>
<div class="line"><span class="stringliteral">                      color: #000000;</span></div>
<div class="line"><span class="stringliteral">                      font-size: 12px;</span></div>
<div class="line"><span class="stringliteral">                      border: 2px solid black;</span></div>
<div class="line"><span class="stringliteral">                      padding: 10px; }}&quot;</span></div>
<div class="line">                    )</div>
<div class="line">                ),</div>
<div class="line">                <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;body&quot;</span>,</div>
<div class="line">                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;p&quot;</span>, <span class="stringliteral">&quot;Promotions with overlaps since &quot;</span> + past.ToString(<span class="stringliteral">&quot;f&quot;</span>) + <span class="stringliteral">&quot; exist in:&quot;</span>),</div>
<div class="line">                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;ul&quot;</span>,</div>
<div class="line">                        <a class="code" href="group__acenum.html#gga2149004df4de6f7f8763b1c46d4ade17ad98a07f84921b24ee30f86fd8cd85c3c">from</a> s in map</div>
<div class="line">                        orderby s.Key <span class="comment">// stream name</span></div>
<div class="line">                        select <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;li&quot;</span>, s.Key)),</div>
<div class="line">                        <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;table&quot;</span>,</div>
<div class="line">                            <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;thead&quot;</span>,</div>
<div class="line">                                <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;tr&quot;</span>,</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;TransID&quot;</span>),</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;TransTime&quot;</span>),</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Promoter&quot;</span>),</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Elements&quot;</span>)</div>
<div class="line">                                )</div>
<div class="line">                            ),</div>
<div class="line">                            <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;tbody&quot;</span>,</div>
<div class="line">                                <a class="code" href="group__acenum.html#gga2149004df4de6f7f8763b1c46d4ade17ad98a07f84921b24ee30f86fd8cd85c3c">from</a> t in trans</div>
<div class="line">                                orderby _users.getUser((<span class="keywordtype">string</span>)t.Attribute(<span class="stringliteral">&quot;user&quot;</span>)), t.acxTime(<span class="stringliteral">&quot;time&quot;</span>) descending <span class="comment">// by user with their latest transactions on top</span></div>
<div class="line">                                select <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;tr&quot;</span>,</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, (<span class="keywordtype">int</span>)t.Attribute(<span class="stringliteral">&quot;id&quot;</span>)),</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, ((DateTime)t.acxTime(<span class="stringliteral">&quot;time&quot;</span>)).ToString(<span class="stringliteral">&quot;g&quot;</span>)),</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, _users.getUser((<span class="keywordtype">string</span>)t.Attribute(<span class="stringliteral">&quot;user&quot;</span>)) + <span class="stringliteral">&quot; (&quot;</span> + (<span class="keywordtype">string</span>)t.Attribute(<span class="stringliteral">&quot;user&quot;</span>) + <span class="stringliteral">&quot;)&quot;</span>, <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;br&quot;</span>),</div>
<div class="line">                                        business((<span class="keywordtype">string</span>)t.Attribute(<span class="stringliteral">&quot;user&quot;</span>)), <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;br&quot;</span>), mobile((<span class="keywordtype">string</span>)t.Attribute(<span class="stringliteral">&quot;user&quot;</span>))),</div>
<div class="line">                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>,</div>
<div class="line">                                        <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;table&quot;</span>,</div>
<div class="line">                                            <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;caption&quot;</span>, t.acxComment()),</div>
<div class="line">                                            <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;thead&quot;</span>,</div>
<div class="line">                                                <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;tr&quot;</span>,</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;EID&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Element&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Location&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Real&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Virtual&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, <span class="stringliteral">&quot;Status&quot;</span>)</div>
<div class="line">                                                )</div>
<div class="line">                                            ),</div>
<div class="line">                                            <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;tbody&quot;</span>,</div>
<div class="line">                                                <a class="code" href="group__acenum.html#gga2149004df4de6f7f8763b1c46d4ade17ad98a07f84921b24ee30f86fd8cd85c3c">from</a> v in t.Elements(<span class="stringliteral">&quot;version&quot;</span>)</div>
<div class="line">                                                where (<span class="keywordtype">int</span>?)v.Attribute(<span class="stringliteral">&quot;eid&quot;</span>) != null</div>
<div class="line">                                                orderby Path.GetFileName((<span class="keywordtype">string</span>)v.Attribute(<span class="stringliteral">&quot;path&quot;</span>))</div>
<div class="line">                                                select <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;tr&quot;</span>,</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, (<span class="keywordtype">int</span>)v.Attribute(<span class="stringliteral">&quot;eid&quot;</span>)),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, Path.GetFileName((<span class="keywordtype">string</span>)v.Attribute(<span class="stringliteral">&quot;path&quot;</span>))),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, Path.GetDirectoryName((<span class="keywordtype">string</span>)v.Attribute(<span class="stringliteral">&quot;path&quot;</span>))),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, $<span class="stringliteral">&quot;{(string)v.Attribute(&quot;</span>realNamedVersion<span class="stringliteral">&quot;)} ({(string)v.Attribute(&quot;</span>real<span class="stringliteral">&quot;)})&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, $<span class="stringliteral">&quot;{(string)v.Attribute(&quot;</span>virtualNamedVersion<span class="stringliteral">&quot;)} ({(string)v.Attribute(&quot;</span><span class="keyword">virtual</span><span class="stringliteral">&quot;)})&quot;</span>),</div>
<div class="line">                                                    <span class="keyword">new</span> XElement(<span class="stringliteral">&quot;td&quot;</span>, (Stat.getElement(v) != null ? Stat.getElement(v).Status : <span class="stringliteral">&quot;(earlier)&quot;</span>))</div>
<div class="line">                                                )</div>
<div class="line">                                            )</div>
<div class="line">                                        )</div>
<div class="line">                                    )</div>
<div class="line">                                )</div>
<div class="line">                            )</div>
<div class="line">                        )</div>
<div class="line">                    )</div>
<div class="line">                )</div>
<div class="line">            );</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> doc;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get user&#39;s business phone number if available, otherwise an empty string.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">string</span> business(<span class="keywordtype">string</span> prncpl)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">string</span> phone = null;</div>
<div class="line">            AcUser <a name="a3"></a><a class="code" href="group__acenum.html#ggaa9826c7afff7ad23871825b95a0a631baee11cbb19052e40b07aac0ca060c23ee">user</a> = _users.getUser(prncpl);</div>
<div class="line">            <span class="keywordflow">if</span> (user != null)</div>
<div class="line">                phone = user.Business;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> (String.IsNullOrEmpty(phone)) ? String.Empty : phone + <span class="stringliteral">&quot;(b)&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Get user&#39;s mobile phone number if available, otherwise an empty string.</span></div>
<div class="line">        <span class="comment">// Demonstrates how to retrieve user properties beyond the regular default set.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">string</span> mobile(<span class="keywordtype">string</span> prncpl)</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">string</span> phone = null;</div>
<div class="line">            AcUser <a class="code" href="group__acenum.html#ggaa9826c7afff7ad23871825b95a0a631baee11cbb19052e40b07aac0ca060c23ee">user</a> = _users.getUser(prncpl);</div>
<div class="line">            <span class="keywordflow">if</span> (user != null)</div>
<div class="line">                phone = user.Other.ContainsKey(<span class="stringliteral">&quot;Mobile&quot;</span>) ? (string)user.Other[<span class="stringliteral">&quot;Mobile&quot;</span>] : null;</div>
<div class="line"></div>
<div class="line">            return (String.IsNullOrEmpty(phone)) ? String.Empty : phone + <span class="stringliteral">&quot;(m)&quot;</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// General program startup initialization.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> init()</div>
<div class="line">        {</div>
<div class="line">            <span class="comment">// initialize our logging support so we can log errors</span></div>
<div class="line">            <span class="keywordflow">if</span> (!AcDebug.initAcLogging())</div>
<div class="line">            {</div>
<div class="line">                Console.WriteLine(<span class="stringliteral">&quot;Logging support initialization failed.&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// in the event of an unhandled exception, save it to our log file before the program terminates</span></div>
<div class="line">            AppDomain.CurrentDomain.UnhandledException += <span class="keyword">new</span> UnhandledExceptionEventHandler(AcDebug.unhandledException);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// ensure we&#39;re logged into AccuRev</span></div>
<div class="line">            Task&lt;string&gt; prncpl = AcQuery.getPrincipalAsync();</div>
<div class="line">            <span class="keywordflow">if</span> (String.IsNullOrEmpty(prncpl.Result))</div>
<div class="line">            {</div>
<div class="line">                AcDebug.Log($<span class="stringliteral">&quot;Not logged into AccuRev.{Environment.NewLine}Please login and try again.&quot;</span>);</div>
<div class="line">                <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="comment">// initialize our class variables from LatestOverlaps.exe.config</span></div>
<div class="line">            <span class="keywordflow">if</span> (!initAppConfigData()) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">            _depots = <span class="keyword">new</span> AcDepots(dynamicOnly: <span class="keyword">true</span>); <span class="comment">// dynamic streams only</span></div>
<div class="line">            Task&lt;bool&gt; dini = _depots.initAsync(_selDepots);</div>
<div class="line"></div>
<div class="line">            <span class="comment">// exclude group membership initialization, include deactivated users</span></div>
<div class="line">            _users = <span class="keyword">new</span> AcUsers(_domains, _properties, includeGroupsList: <span class="keyword">false</span>, includeDeactivated: <span class="keyword">true</span>);</div>
<div class="line">            Task&lt;bool&gt; uini = _users.initAsync();</div>
<div class="line"></div>
<div class="line">            Task&lt;bool[]&gt; arr = Task.WhenAll(dini, uini); <span class="comment">// initialize both in parallel</span></div>
<div class="line">            <span class="keywordflow">if</span> (arr == null || arr.Result.Any(n =&gt; n == <span class="keyword">false</span>)) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Initialize our class variables with values from LatestOverlaps.exe.config. Returns true if all values </span></div>
<div class="line">        <span class="comment">// successfully read and class variables initialized, false otherwise. ConfigurationErrorsException caught </span></div>
<div class="line">        <span class="comment">// and logged in %LOCALAPPDATA%\AcTools\Logs\LatestOverlaps-YYYY-MM-DD.log on initialization failure.</span></div>
<div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keywordtype">bool</span> initAppConfigData()</div>
<div class="line">        {</div>
<div class="line">            <span class="keywordtype">bool</span> ret = <span class="keyword">true</span>; <span class="comment">// assume success</span></div>
<div class="line">            <span class="keywordflow">try</span></div>
<div class="line">            {</div>
<div class="line">                _fromHoursAgo = AcQuery.getAppConfigSetting&lt;<span class="keywordtype">int</span>&gt;(<span class="stringliteral">&quot;FromHoursAgo&quot;</span>);</div>
<div class="line">                _outputFile = AcQuery.getAppConfigSetting&lt;<span class="keywordtype">string</span>&gt;(<span class="stringliteral">&quot;OutputFile&quot;</span>).Trim();</div>
<div class="line"></div>
<div class="line">                ADSection adSection = ConfigurationManager.GetSection(<span class="stringliteral">&quot;activeDir&quot;</span>) as ADSection;</div>
<div class="line">                <span class="keywordflow">if</span> (adSection == null)</div>
<div class="line">                {</div>
<div class="line">                    AcDebug.Log(<span class="stringliteral">&quot;Error in Program.initAppConfigData creating ADSection&quot;</span>);</div>
<div class="line">                    ret = <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                {</div>
<div class="line">                    _domains = adSection.Domains;</div>
<div class="line">                    _properties = adSection.Props;</div>
<div class="line">                }</div>
<div class="line"></div>
<div class="line">                DepotsSection depotsConfigSection = ConfigurationManager.GetSection(<span class="stringliteral">&quot;Depots&quot;</span>) as DepotsSection;</div>
<div class="line">                <span class="keywordflow">if</span> (depotsConfigSection == null)</div>
<div class="line">                {</div>
<div class="line">                    AcDebug.Log(<span class="stringliteral">&quot;Error in Program.initAppConfigData creating DepotsSection&quot;</span>);</div>
<div class="line">                    ret = <span class="keyword">false</span>;</div>
<div class="line">                }</div>
<div class="line">                <span class="keywordflow">else</span></div>
<div class="line">                    _selDepots = depotsConfigSection.Depots;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">catch</span> (ConfigurationErrorsException exc)</div>
<div class="line">            {</div>
<div class="line">                Process currentProcess = Process.GetCurrentProcess();</div>
<div class="line">                ProcessModule pm = currentProcess.MainModule;</div>
<div class="line">                AcDebug.Log($<span class="stringliteral">&quot;Invalid data in {pm.ModuleName}.config{Environment.NewLine}{exc.Message}&quot;</span>);</div>
<div class="line">                ret = <span class="keyword">false</span>;</div>
<div class="line">            }</div>
<div class="line"></div>
<div class="line">            <span class="keywordflow">return</span> ret;</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Sep 20 2018 16:04:49 for AcUtils by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.9.1
</small></address>
</body>
</html>
